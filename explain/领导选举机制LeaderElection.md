## 领导选举机制 Leader Election

### Heartbeat 和选举触发流程

Raft 使用一种心跳机制 heartbeat 来触发 leader 选举。

1. 节点启动时是 follower 状态；只要能持续从 leader 或 candidate 收到合法的 RPC 请求，就会一直保持在 follower 状态；
2. Leader 定期发送心跳给（空的 Append Entries 消息）所有的 follower，以保持它的权威；
3. 如果一个 follower 在选举超时时间段内都没有收到来自 leader or candidate 的通信，就认为当前已经没有有效 leader 了，然后发起一次选举。

​	根据 Raft 论文原文我们可以知道，在 Raft 中，有两个控制选举的超时设置。首先是选举超时。选举超时是追随者在成为候选人之前等待的时间。选举超时随机设置为 150 毫秒到 300 毫秒之间。

### 选举过程

对于一个 follower，当开始选举时，

1. 首先增大自己当前的 term 任期号，
2. 然后切换到 candidate 候选人状态，
3. 然后选举自己作为 leader ，为自己投一票的同时并发地向集群其他节点发送 RequestVote RPC，
4. 然后它将处于 candidate 状态，直到发生以下三种情况之一，下文会分别讨论：

1. 1. 该 follower 赢得此次选举，成为 leader；
   2. 另一个节点赢得此次选举，成为 leader；
   3. 选举超时，没有产生有效 leader。

### 获胜的判断条件

​	如果一个 candidate 获得了集群大多数节点针对同一任期（term）的投票， 那它就赢得了这个任期内的选举。

​	针对给定的任期，每个节点最多只能投一票，投票的标准是先到先得（ first-come-first-served）。“期得获该任期的大 多数选票”这一限制条件，决定了最多只会有一个 candidate 赢得选举 。一个 candidate 赢得选举之后，就会为 leader，然后发生心跳消息 给所有其他节点来建立它的权威，防止新的选举发生。

​	在等待投票期间，一个 candidate 可能会从其他服务器收到一个 AppendEntries RPC 声称自己是 leader。如果这个 leader 的任期 term （包含在 RPC 消息中）：

1. 大于等于这个 candidate 的 currentTerm：那该 candidate 就承认 这个 leader 是合法的，然后回归到 follower 状态。
2. 小于这个 candidate 的 currentTerm：拒绝这个 RPC ，仍然留在 candidate 状态。

​	第 3 种可能的结果是：该 candidate 既没有赢得也没有输掉这次选举。 如果多个 followers 在同一时间成为 candidates，投票就会很分散，最终没有谁能赢得大多数选票。 当发生这种情况时，每个 candidate 都会超时，然后各自增大 term 并给其他节点发送 RequestVote 请求，开始一轮新选举， 但如果没有额外的预防措施，这种投票分裂的情况看可能会无限持续下去。

### 避免无限循环的投票分裂：随机选举超时

​	Raft 使用随机选举超时来确保投票分裂 只会非常偶然地发生，并且发生之后能很快恢复正常。

​	首先是从一些固定时长（例如 `150-300ms`）中随机选择一个选举超时时间，这使得节点的超时时刻比较分散，在大部分情况下同一时刻最多只有一台会超时； 这台超时的节点会在其他节点超时之前赢得选举（因为它的 term 更大，其他节点都会投票给它）。

​	随机化机制也同样用于处理投票分裂。每个 candidate 在一轮选举开始时， 会随机重置它的 election timeout，等到 timeout 之后才开始发起新一轮选举；这减少 了新一轮选举也发生投票分裂的可能性。这种方式很快就能选出 leader。

### Leader Election 可视化过程

​	可视化网站：https://thesecretlivesofdata.com/raft/#intro，根据可视化网站提供的完全过程，我们逐步分析，并且对细节处进行标记。

| ![img](https://cdn.nlark.com/yuque/0/2024/png/51059439/1733924152623-0625d3a9-5c15-4d04-b90c-801e1cf15324.png) | ![img](https://cdn.nlark.com/yuque/0/2024/png/51059439/1733924216207-66153bde-d5ec-41ca-bac5-10d8f4883675.png) |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| 图1  Leader 选举流程                                         | 图1  Leader 选举流程                                         |

​	首先，根据上述图片我们能清楚的知道，每一个节点自身都会记录当前任期号 currentTerm，无论处于那种状态，当我们每一个 follower 状态的节点在所设置的超时时间内没有接收到来自 leader or candidate 节点的通信，则会开启一轮选举，也就是选举超时后，追随者成为候选人并开始新的选举任期。

​	在任期开始时，候选节点总会将票投给自己同时并向其他节点发送 Request Vote 消息，尝试获取其他节点的投票，如下流程：

| ![img](https://cdn.nlark.com/yuque/0/2024/png/51059439/1733924894997-a8e5d70a-f3ba-4f7e-a921-73402d417d59.png) | ![img](https://cdn.nlark.com/yuque/0/2024/png/51059439/1733925532887-a312a67f-aa8f-4b25-8451-dc3dba2d3607.png) |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| 图2  Leader 选举流程                                         | 图2  Leader 选举流程                                         |

​	此过程，如果接收节点在此期限内尚未投票，则它会投票给候选人，并且节点将重置其选举超时。一旦候选人获得多数票（半数以上），它就会成为领导者。

| ![img](https://cdn.nlark.com/yuque/0/2024/png/51059439/1733925538874-10f9b8ca-da7e-4080-be4b-e444e3277b20.png) |
| ------------------------------------------------------------ |
| 图3  Leader 选举完毕                                         |

​	接下来，领导者开始向其余 followers 状态的节点发送 Append Entries 消息，在此尚且称为心跳包。这些消息按检测信号超时指定的时间间隔发送。然后，关注者会回复每条心跳包。

| ![img](https://cdn.nlark.com/yuque/0/2024/png/51059439/1733925552314-e0a53b69-56a7-4620-826d-fb69354a92bd.png) | ![img](https://cdn.nlark.com/yuque/0/2024/png/51059439/1733925738278-52178e55-0fd4-4f1b-8a34-d3d5be0e8f14.png) |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| 图4  Leader 选举完毕后续                                     | 图4  Leader 选举完毕后续                                     |

​	就此，会循环反复的重复发送心跳包，此时此选举任期将持续到关注者停止接收心跳并成为候选人。

​	接下来让我们模拟领导人出现问题，看看 Raft 协议是如何处理的，可以看到我们模拟 leader 节点宕机后，Follower 节点会收不到来自 leader or candidate 的通信，此时会在此触发 Leader 选举。

| ![img](https://cdn.nlark.com/yuque/0/2024/png/51059439/1733927360388-b388a43e-2b6a-4c30-81ac-97fc790371ef.png) | ![img](https://cdn.nlark.com/yuque/0/2024/png/51059439/1733927562407-d7346efb-3bc4-4959-ae1a-52b985d58442.png) |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| 图5 领导人宕机故障处理                                       | 图5 领导人宕机故障处理                                       |

​	经过选举后，我们可以看见节点 A 成为了新的 Leader 节点，因为该集群总共 3 个节点，自己一票同时收到节点 Ｂ 的一票，则此时选举成为 Leader 节点，在节点 A 的超时时间到后，此时自身的 Term + 1，然后将从 Follower 状态变成 Candidate 状态，，同时会向集群的其他节点发送 RequestVote RPC 从而获取其他选票。

​	接下来，让我们看一个拆分投票的例子，从而看看 Raft 是如何解决该问题的：

| ![img](https://cdn.nlark.com/yuque/0/2024/png/51059439/1733929547667-62282f37-6bef-4015-9c35-b67a4353f9d2.png) | ![img](https://cdn.nlark.com/yuque/0/2024/png/51059439/1733929667148-b9642b2e-5c29-47bc-b7ca-e3e49f96ce9c.png) |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| 图6  Leader 选举拆分投票                                     | 图6  Leader 选举拆分投票                                     |

​	可以看到，现在将从 3 个节点换成 4 个节点，此时发生了**两个节点都启动同一期限的选举**，根据下图又可得知，每个节点都比另一个节点先到达一个 follower 节点。

| ![img](https://cdn.nlark.com/yuque/0/2024/png/51059439/1733929719333-b48d4b7f-49ce-434f-9bef-2df68ff01cf4.png) | ![img](https://cdn.nlark.com/yuque/0/2024/png/51059439/1733929841505-4c4da496-e3c8-4a04-a561-11b005fef067.png) |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| 图7  Leader 选举拆分投票                                     | 图7  Leader 选举拆分投票                                     |

则现在这种特殊情况导致，现在每个候选人都有 2 票，本届任期不能再获得 Leader 节点，因为没有一个节点获得了超过半数的票数。而这时的 Candidate 节点将不会有后续操作，同时 Follower 节点也没有收到 Leader or Candidate 节点发来的消息，则会进入新一轮的 Leader 选举。

| ![img](https://cdn.nlark.com/yuque/0/2024/png/51059439/1733929934925-bd5daf26-8c73-4567-9893-99256ed855d7.png) | ![img](https://cdn.nlark.com/yuque/0/2024/png/51059439/1733988553191-85c581fd-c761-470c-989b-d10a7dd20531.png) |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| 图8  Leader 选举拆分投票                                     | 图8  Leader 选举拆分投票                                     |

​	最终，总会存在某一次选举的过程中，选举出 Leader 节点出来。根据上图可知，最终节点 C 选举成功，获得了大多数节点的票，从而当选 Leader。